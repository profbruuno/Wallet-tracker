<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Wallet Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.87.6/lib/index.iife.min.js"></script>
    <style>
        :root {
            --primary: #9945FF;
            --secondary: #14F195;
            --dark: #121212;
            --dark-card: #1E1E1E;
            --text: #FFFFFF;
            --text-secondary: #B0B0B0;
            --border: #333333;
            --positive: #14F195;
            --negative: #FF6B6B;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--dark);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo i {
            color: var(--primary);
        }
        
        .wallet-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--dark-card);
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .wallet-address {
            font-family: monospace;
            font-size: 14px;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
        }
        
        .copy-btn:hover {
            color: var(--secondary);
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--dark-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .positive {
            color: var(--positive);
        }
        
        .negative {
            color: var(--negative);
        }
        
        .portfolio-chart {
            background: var(--dark-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 300px;
        }
        
        .tokens-section {
            background: var(--dark-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-box {
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 15px;
            color: var(--text);
            width: 250px;
        }
        
        .tokens-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .tokens-table th {
            text-align: left;
            padding: 15px;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 1px solid var(--border);
        }
        
        .tokens-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .token-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .token-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            overflow: hidden;
        }
        
        .token-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .token-name {
            font-weight: 500;
        }
        
        .token-symbol {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .price-change {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .action-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .refresh-btn:hover {
            background: #7a36cc;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: var(--negative);
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            border-top: 1px solid var(--border);
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--secondary);
        }
        
        .status-indicator.offline {
            background: var(--negative);
        }
        
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .search-box {
                width: 100%;
                margin-top: 10px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .tokens-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-wallet"></i>
                <span>Solana Wallet Tracker</span>
            </div>
            <div class="wallet-info">
                <div class="wallet-address">4pRFMaN7vV35j7iQW9UCPmuWirRd3noGLywguP2i1kVc</div>
                <button class="copy-btn" title="Copy address">
                    <i class="far fa-copy"></i>
                </button>
            </div>
        </header>
        
        <div class="stats-cards">
            <div class="stat-card">
                <h3>Total Portfolio Value</h3>
                <div class="stat-value" id="total-value">Loading...</div>
                <div id="total-change">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>SOL Balance</h3>
                <div class="stat-value" id="sol-balance">Loading...</div>
                <div id="sol-change">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Number of Tokens</h3>
                <div class="stat-value" id="token-count">Loading...</div>
                <div>Different assets</div>
            </div>
            <div class="stat-card">
                <h3>Last Updated</h3>
                <div class="stat-value" id="last-updated">Loading...</div>
                <button class="refresh-btn" id="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <div class="connection-status">
                    <div class="status-indicator" id="status-indicator"></div>
                    <span id="connection-status">Connecting...</span>
                </div>
            </div>
        </div>
        
        <div class="portfolio-chart">
            <div class="chart-header">
                <h2>Portfolio Value</h2>
                <div>
                    <button class="action-btn" id="chart-1d">1D</button>
                    <button class="action-btn" id="chart-1w">1W</button>
                    <button class="action-btn active" id="chart-1m">1M</button>
                    <button class="action-btn" id="chart-3m">3M</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>
        
        <div class="tokens-section">
            <div class="section-header">
                <h2>Wallet Tokens</h2>
                <div>
                    <input type="text" class="search-box" id="search-tokens" placeholder="Search tokens...">
                </div>
            </div>
            <div id="tokens-container">
                <div class="loading" id="tokens-loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading wallet data...
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Solana Wallet Tracker &copy; 2023 | Data from Solana RPC & DexScreener API</p>
        </div>
    </div>

    <script>
        // Configuration
        const WALLET_ADDRESS = "4pRFMaN7vV35j7iQW9UCPmuWirRd3noGLywguP2i1kVc";
        const DEXSCREENER_API_URL = "https://api.dexscreener.com/latest/dex";
        
        // Use multiple RPC endpoints for fallback
        const RPC_ENDPOINTS = [
            "https://api.mainnet-beta.solana.com",
            "https://solana-api.projectserum.com",
            "https://rpc.ankr.com/solana",
            "https://solana-mainnet.rpc.extrnode.com"
        ];
        
        // State
        let tokenData = [];
        let portfolioHistory = [];
        let chart;
        let connection;
        let currentRpcIndex = 0;

        // DOM Elements
        const totalValueEl = document.getElementById('total-value');
        const totalChangeEl = document.getElementById('total-change');
        const solBalanceEl = document.getElementById('sol-balance');
        const solChangeEl = document.getElementById('sol-change');
        const tokenCountEl = document.getElementById('token-count');
        const lastUpdatedEl = document.getElementById('last-updated');
        const refreshBtn = document.getElementById('refresh-btn');
        const tokensContainer = document.getElementById('tokens-container');
        const searchInput = document.getElementById('search-tokens');
        const statusIndicator = document.getElementById('status-indicator');
        const connectionStatus = document.getElementById('connection-status');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            initializeConnection();
        });

        // Set up event listeners
        function initEventListeners() {
            refreshBtn.addEventListener('click', loadWalletData);
            
            searchInput.addEventListener('input', function() {
                filterTokens(this.value);
            });
            
            // Chart period buttons
            document.getElementById('chart-1d').addEventListener('click', () => changeChartPeriod('1d'));
            document.getElementById('chart-1w').addEventListener('click', () => changeChartPeriod('1w'));
            document.getElementById('chart-1m').addEventListener('click', () => changeChartPeriod('1m'));
            document.getElementById('chart-3m').addEventListener('click', () => changeChartPeriod('3m'));
            
            // Copy wallet address
            document.querySelector('.copy-btn').addEventListener('click', function() {
                navigator.clipboard.writeText(WALLET_ADDRESS).then(() => {
                    const originalIcon = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        this.innerHTML = originalIcon;
                    }, 2000);
                });
            });
        }

        // Initialize Solana connection with fallback
        async function initializeConnection() {
            for (let i = 0; i < RPC_ENDPOINTS.length; i++) {
                try {
                    currentRpcIndex = i;
                    const endpoint = RPC_ENDPOINTS[i];
                    console.log(`Trying RPC endpoint: ${endpoint}`);
                    
                    connection = new solanaWeb3.Connection(endpoint);
                    
                    // Test the connection
                    await connection.getEpochInfo();
                    
                    updateConnectionStatus(true, endpoint);
                    console.log(`Connected to ${endpoint}`);
                    await loadWalletData();
                    return;
                } catch (error) {
                    console.error(`Failed to connect to ${RPC_ENDPOINTS[i]}:`, error);
                    if (i === RPC_ENDPOINTS.length - 1) {
                        updateConnectionStatus(false);
                        // Use mock data as last resort
                        useMockData();
                    }
                }
            }
        }

        // Update connection status UI
        function updateConnectionStatus(connected, endpoint = "") {
            if (connected) {
                statusIndicator.classList.remove('offline');
                connectionStatus.textContent = `Connected to ${endpoint.split('//')[1]}`;
            } else {
                statusIndicator.classList.add('offline');
                connectionStatus.textContent = 'Connection failed - using mock data';
            }
        }

        // Load wallet data from APIs
        async function loadWalletData() {
            try {
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing';
                refreshBtn.disabled = true;
                
                // Show loading state
                tokensContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading wallet data...</div>';
                
                // Fetch actual wallet tokens
                const walletTokens = await fetchWalletTokens();
                
                // Fetch token data from DexScreener
                await fetchTokenData(walletTokens);
                
                // Update UI with new data
                updateStats();
                updateTokensTable();
                updatePortfolioChart();
                
                // Update last updated time
                lastUpdatedEl.textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Error loading wallet data:', error);
                // Try next RPC endpoint
                if (currentRpcIndex < RPC_ENDPOINTS.length - 1) {
                    currentRpcIndex++;
                    const nextEndpoint = RPC_ENDPOINTS[currentRpcIndex];
                    console.log(`Trying next RPC endpoint: ${nextEndpoint}`);
                    connection = new solanaWeb3.Connection(nextEndpoint);
                    await loadWalletData();
                } else {
                    tokensContainer.innerHTML = '<div class="error">Error loading wallet data. Using mock data instead.</div>';
                    updateConnectionStatus(false);
                    useMockData();
                }
            } finally {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                refreshBtn.disabled = false;
            }
        }

        // Use mock data when APIs fail
        function useMockData() {
            // Mock wallet tokens
            const mockWalletTokens = [
                { mint: "So11111111111111111111111111111111111111112", symbol: "SOL", amount: 42.75, name: "Solana" },
                { mint: "SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt", symbol: "SRM", amount: 120.5, name: "Serum" },
                { mint: "4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R", symbol: "RAY", amount: 85.2, name: "Raydium" },
                { mint: "orcaEKTdK7LKz57vaAYr9QeNsVEPfiu6QeMU1kektZE", symbol: "ORCA", amount: 25.8, name: "Orca" },
                { mint: "StepAscQoEioFxxWGnh2sLBDFp9d8rvKz2Yp39iDpyT", symbol: "STEP", amount: 500, name: "Step Finance" },
                { mint: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263", symbol: "BONK", amount: 1500000, name: "Bonk" },
                { mint: "JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN", symbol: "JUP", amount: 75.5, name: "Jupiter" },
                { mint: "mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So", symbol: "mSOL", amount: 40.2, name: "Marinade Staked SOL" }
            ];
            
            // Mock prices
            const mockPrices = {
                'SOL': 102.45,
                'SRM': 0.48,
                'RAY': 0.65,
                'ORCA': 4.32,
                'STEP': 0.12,
                'BONK': 0.000012,
                'JUP': 0.85,
                'mSOL': 104.32
            };
            
            // Mock price changes
            const mockChanges = {
                'SOL': 5.2,
                'SRM': -1.2,
                'RAY': 3.7,
                'ORCA': 8.1,
                'STEP': -2.4,
                'BONK': 15.3,
                'JUP': 2.1,
                'mSOL': 4.8
            };
            
            // Process mock data
            tokenData = mockWalletTokens.map(token => ({
                ...token,
                price: mockPrices[token.symbol] || 0,
                value: token.amount * (mockPrices[token.symbol] || 0),
                priceChange: mockChanges[token.symbol] || 0,
                icon: null
            }));
            
            // Sort by value (highest first)
            tokenData.sort((a, b) => b.value - a.value);
            
            // Update UI
            updateStats();
            updateTokensTable();
            updatePortfolioChart();
            lastUpdatedEl.textContent = new Date().toLocaleTimeString() + " (Mock Data)";
        }

        // Fetch actual tokens from Solana wallet
        async function fetchWalletTokens() {
            const walletTokens = [];
            
            try {
                // Get SOL balance
                const publicKey = new solanaWeb3.PublicKey(WALLET_ADDRESS);
                const solBalance = await connection.getBalance(publicKey);
                const solAmount = solBalance / solanaWeb3.LAMPORTS_PER_SOL;
                
                if (solAmount > 0) {
                    walletTokens.push({
                        mint: "So11111111111111111111111111111111111111112",
                        symbol: "SOL",
                        amount: solAmount,
                        name: "Solana"
                    });
                }
                
                // Get SPL tokens using getParsedTokenAccountsByOwner
                const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
                    publicKey,
                    {
                        programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA")
                    }
                );
                
                // Process each token account
                for (const account of tokenAccounts.value) {
                    const parsedInfo = account.account.data.parsed.info;
                    const mint = parsedInfo.mint;
                    const tokenAmount = parsedInfo.tokenAmount;
                    
                    // Only include tokens with balance > 0
                    if (tokenAmount.uiAmount > 0) {
                        // Try to get token metadata
                        let tokenName = "Unknown Token";
                        let tokenSymbol = "UNKNOWN";
                        
                        try {
                            const metadata = await getTokenMetadata(mint);
                            tokenName = metadata.name || tokenName;
                            tokenSymbol = metadata.symbol || tokenSymbol;
                        } catch (e) {
                            console.log(`Could not fetch metadata for ${mint}`);
                        }
                        
                        walletTokens.push({
                            mint: mint,
                            symbol: tokenSymbol,
                            amount: tokenAmount.uiAmount,
                            name: tokenName
                        });
                    }
                }
                
                console.log("Found tokens:", walletTokens);
                return walletTokens;
            } catch (error) {
                console.error('Error fetching wallet tokens:', error);
                throw new Error('Failed to fetch wallet tokens');
            }
        }

        // Get token metadata
        async function getTokenMetadata(mintAddress) {
            // Try to get from known token list first
            const knownTokens = {
                "So11111111111111111111111111111111111111112": { name: "Solana", symbol: "SOL" },
                "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v": { name: "USD Coin", symbol: "USDC" },
                "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB": { name: "Tether", symbol: "USDT" },
                "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263": { name: "Bonk", symbol: "BONK" },
                "JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN": { name: "Jupiter", symbol: "JUP" },
                "mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So": { name: "Marinade Staked SOL", symbol: "mSOL" }
            };
            
            if (knownTokens[mintAddress]) {
                return knownTokens[mintAddress];
            }
            
            // Try to fetch from DexScreener
            try {
                const response = await fetch(`${DEXSCREENER_API_URL}/search?q=${mintAddress}`);
                if (!response.ok) throw new Error('DexScreener API error');
                
                const data = await response.json();
                
                if (data.pairs && data.pairs.length > 0) {
                    const pair = data.pairs[0];
                    return {
                        name: pair.baseToken.name || "Unknown Token",
                        symbol: pair.baseToken.symbol || "UNKNOWN"
                    };
                }
            } catch (e) {
                console.log(`Could not fetch metadata for ${mintAddress} from DexScreener`);
            }
            
            return { name: "Unknown Token", symbol: "UNKNOWN" };
        }

        // Fetch token data from DexScreener API
        async function fetchTokenData(walletTokens) {
            tokenData = [];
            
            if (!walletTokens || walletTokens.length === 0) {
                return;
            }
            
            // Create array of token addresses to fetch
            const tokenAddresses = walletTokens.map(token => token.mint);
            
            try {
                // Fetch data for all tokens
                const response = await fetch(`${DEXSCREENER_API_URL}/tokens/${tokenAddresses.join(',')}`);
                if (!response.ok) throw new Error('DexScreener API error');
                
                const data = await response.json();
                
                // Process token data
                if (data && data.pairs) {
                    for (const walletToken of walletTokens) {
                        // Find matching token in API response
                        const tokenInfo = data.pairs.find(pair => 
                            pair.baseToken && pair.baseToken.address === walletToken.mint
                        );
                        
                        if (tokenInfo) {
                            const price = parseFloat(tokenInfo.priceUsd) || 0;
                            const priceChange = tokenInfo.priceChange ? 
                                (parseFloat(tokenInfo.priceChange.h24) || 0) : 0;
                            
                            tokenData.push({
                                ...walletToken,
                                price: price,
                                value: walletToken.amount * price,
                                priceChange: priceChange,
                                icon: tokenInfo.baseToken.logoURI || null
                            });
                        } else {
                            // If token not found in API, try to search for it
                            try {
                                const searchResponse = await fetch(`${DEXSCREENER_API_URL}/search?q=${walletToken.mint}`);
                                if (!searchResponse.ok) throw new Error('DexScreener search error');
                                
                                const searchData = await searchResponse.json();
                                
                                if (searchData.pairs && searchData.pairs.length > 0) {
                                    const pair = searchData.pairs[0];
                                    const price = parseFloat(pair.priceUsd) || 0;
                                    const priceChange = pair.priceChange ? 
                                        (parseFloat(pair.priceChange.h24) || 0) : 0;
                                    
                                    tokenData.push({
                                        ...walletToken,
                                        price: price,
                                        value: walletToken.amount * price,
                                        priceChange: priceChange,
                                        icon: pair.baseToken.logoURI || null
                                    });
                                } else {
                                    // If still not found, add with zero values
                                    tokenData.push({
                                        ...walletToken,
                                        price: 0,
                                        value: 0,
                                        priceChange: 0,
                                        icon: null
                                    });
                                }
                            } catch (searchError) {
                                console.error(`Error searching for token ${walletToken.mint}:`, searchError);
                                // Add with zero values if search fails
                                tokenData.push({
                                    ...walletToken,
                                    price: 0,
                                    value: 0,
                                    priceChange: 0,
                                    icon: null
                                });
                            }
                        }
                    }
                } else {
                    throw new Error('No pairs data from DexScreener');
                }
            } catch (error) {
                console.error('Error fetching token data:', error);
                // If all API calls fail, use mock data
                useMockData();
                return;
            }
            
            // Sort by value (highest first)
            tokenData.sort((a, b) => b.value - a.value);
        }

        // Update statistics cards
        function updateStats() {
            // Calculate total portfolio value
            const totalValue = tokenData.reduce((sum, token) => sum + token.value, 0);
            totalValueEl.textContent = `$${totalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            
            // Calculate 24h change (weighted average based on token values)
            let totalChangeValue = 0;
            let totalWeight = 0;
            
            tokenData.forEach(token => {
                if (token.value > 0 && token.priceChange) {
                    totalChangeValue += token.value * (token.priceChange / 100);
                    totalWeight += token.value;
                }
            });
            
            const totalChangePercent = totalWeight > 0 ? (totalChangeValue / totalWeight) * 100 : 0;
            
            totalChangeEl.textContent = `${totalChangePercent >= 0 ? '+' : ''}${totalChangePercent.toFixed(2)}%`;
            totalChangeEl.className = totalChangePercent >= 0 ? 'positive' : 'negative';
            
            // Update SOL info
            const solToken = tokenData.find(token => token.symbol === 'SOL');
            if (solToken) {
                solBalanceEl.textContent = `${solToken.amount.toLocaleString(undefined, { maximumFractionDigits: 2 })} SOL`;
                solChangeEl.textContent = `${solToken.priceChange >= 0 ? '+' : ''}${solToken.priceChange.toFixed(2)}%`;
                solChangeEl.className = solToken.priceChange >= 0 ? 'positive' : 'negative';
            }
            
            // Update token count (excluding SOL)
            const tokenCount = tokenData.filter(token => token.symbol !== 'SOL').length;
            tokenCountEl.textContent = tokenCount;
        }

        // Update tokens table
        function updateTokensTable() {
            if (tokenData.length === 0) {
                tokensContainer.innerHTML = '<div class="error">No tokens found in wallet</div>';
                return;
            }
            
            let html = `
                <table class="tokens-table">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Balance</th>
                            <th>Price</th>
                            <th>Value</th>
                            <th>24h Change</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            tokenData.forEach(token => {
                const changeClass = token.priceChange >= 0 ? 'positive' : 'negative';
                const changeIcon = token.priceChange >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                const displayPrice = token.price < 0.01 ? token.price.toFixed(6) : token.price.toFixed(token.price < 1 ? 4 : 2);
                
                html += `
                    <tr>
                        <td>
                            <div class="token-info">
                                <div class="token-icon">
                                    ${token.icon ? 
                                        `<img src="${token.icon}" alt="${token.symbol}" onerror="this.style.display='none'">` : 
                                        token.symbol.charAt(0)
                                    }
                                </div>
                                <div>
                                    <div class="token-name">${token.name}</div>
                                    <div class="token-symbol">${token.symbol}</div>
                                </div>
                            </div>
                        </td>
                        <td>${token.amount.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>
                        <td>$${displayPrice}</td>
                        <td>$${token.value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="${changeClass}">
                            <i class="fas ${changeIcon}"></i>
                            ${Math.abs(token.priceChange).toFixed(2)}%
                        </td>
                        <td>
                            <div class="actions">
                                <button class="action-btn" onclick="tradeToken('${token.mint}')">Trade</button>
                                <button class="action-btn" onclick="viewTokenDetails('${token.mint}')">Details</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            tokensContainer.innerHTML = html;
        }

        // Filter tokens based on search input
        function filterTokens(searchTerm) {
            const rows = document.querySelectorAll('.tokens-table tbody tr');
            
            rows.forEach(row => {
                const tokenName = row.querySelector('.token-name').textContent.toLowerCase();
                const tokenSymbol = row.querySelector('.token-symbol').textContent.toLowerCase();
                const search = searchTerm.toLowerCase();
                
                if (tokenName.includes(search) || tokenSymbol.includes(search)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Initialize portfolio chart
        function initPortfolioChart() {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            // Generate initial data for the chart
            const dates = [];
            const values = [];
            
            // Start with current portfolio value
            const currentValue = tokenData.reduce((sum, token) => sum + token.value, 0) || 10000;
            
            // Generate some historical data
            for (let i = 30; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                // Simulate price fluctuations
                const fluctuation = (Math.random() - 0.5) * 0.1; // ±5% daily change
                const historicalValue = currentValue * (1 - (i * 0.01)) * (1 + fluctuation);
                values.push(Math.max(historicalValue, 0));
            }
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(153, 69, 255, 0.3)');
            gradient.addColorStop(1, 'rgba(153, 69, 255, 0)');
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: values,
                        borderColor: '#9945FF',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(30, 30, 30, 0.9)',
                            titleColor: '#FFFFFF',
                            bodyColor: '#FFFFFF',
                            borderColor: '#333333',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#B0B0B0'
                            }
                        },
                        y: {
                            grid: {
                                color: '#333333',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#B0B0B0',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update portfolio chart with new data
        function updatePortfolioChart() {
            if (!chart) {
                initPortfolioChart();
                return;
            }
            
            // In a real app, you would update with actual historical data
            // For demo, we'll just add a new data point
            const currentValue = tokenData.reduce((sum, token) => sum + token.value, 0);
            
            // Add new data point and remove the oldest
            chart.data.labels.push(new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            chart.data.labels.shift();
            
            chart.data.datasets[0].data.push(currentValue);
            chart.data.datasets[0].data.shift();
            
            chart.update();
        }

        // Change chart period
        function changeChartPeriod(period) {
            // Remove active class from all buttons
            document.querySelectorAll('.chart-header .action-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // In a real app, you would fetch new data for the selected period
            console.log(`Changed chart period to: ${period}`);
        }

        // Token action functions
        function tradeToken(mint) {
            window.open(`https://jup.ag/swap/SOL-${mint}`, '_blank');
        }

        function viewTokenDetails(mint) {
            window.open(`https://solscan.io/token/${mint}`, '_blank');
        }

        // Initialize chart on load
        initPortfolioChart();
    </script>
</body>
</html>
